name: SEO Optimization & Static Pages Generation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# 🔧 關鍵：權限設定
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  seo-optimization:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate static redirect pages
      run: |
        # 生成 about.html
        cat > about.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
          <meta charset="UTF-8">
          <title>關於作者 | AIOGEO 知識庫</title>
          <meta name="description" content="廖天佑 Bless Liao - GEO (生成式引擎優化) 專家，專精AI搜尋優化策略與內容架構設計">
          <meta http-equiv="refresh" content="0; url=https://bless25min.github.io/AIOGEO-Knowledge/#/about">
          <link rel="canonical" href="https://bless25min.github.io/AIOGEO-Knowledge/#/about">
          <script>window.location.href='https://bless25min.github.io/AIOGEO-Knowledge/#/about';</script>
        </head>
        <body>
          <h1>關於作者 - AIOGEO 知識庫</h1>
          <p>正在重定向到 <a href="https://bless25min.github.io/AIOGEO-Knowledge/#/about">關於作者頁面</a></p>
          <p>如果沒有自動跳轉，請點擊上方連結。</p>
        </body>
        </html>
        EOF
        
        # 生成 contributing.html
        cat > contributing.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
          <meta charset="UTF-8">
          <title>參與貢獻 | AIOGEO 知識庫</title>
          <meta name="description" content="加入 AIOGEO 知識庫建設，共同推動 GEO 領域發展。提供貢獻指南與最佳實務">
          <meta http-equiv="refresh" content="0; url=https://bless25min.github.io/AIOGEO-Knowledge/#/contributing">
          <link rel="canonical" href="https://bless25min.github.io/AIOGEO-Knowledge/#/contributing">
          <script>window.location.href='https://bless25min.github.io/AIOGEO-Knowledge/#/contributing';</script>
        </head>
        <body>
          <h1>參與貢獻 - AIOGEO 知識庫</h1>
          <p>正在重定向到 <a href="https://bless25min.github.io/AIOGEO-Knowledge/#/contributing">參與貢獻頁面</a></p>
          <p>如果沒有自動跳轉，請點擊上方連結。</p>
        </body>
        </html>
        EOF
        
    - name: Generate optimized sitemap
      run: |
        cat > sitemap.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/</loc>
                <lastmod>REPLACE_DATE</lastmod>
                <changefreq>weekly</changefreq>
                <priority>1.0</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/about.html</loc>
                <lastmod>REPLACE_DATE</lastmod>
                <changefreq>monthly</changefreq>
                <priority>0.8</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/contributing.html</loc>
                <lastmod>REPLACE_DATE</lastmod>
                <changefreq>monthly</changefreq>
                <priority>0.6</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/#!/about</loc>
                <lastmod>REPLACE_DATE</lastmod>
                <changefreq>monthly</changefreq>
                <priority>0.7</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/#!/posts/geo-fundamentals</loc>
                <lastmod>REPLACE_DATE</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.9</priority>
            </url>
        </urlset>
        EOF
        
        # 替換日期
        sed -i "s/REPLACE_DATE/$(date +%Y-%m-%d)/g" sitemap.xml
        
    - name: Generate robots.txt
      run: |
        cat > robots.txt << 'EOF'
        User-agent: *
        Allow: /
        
        Sitemap: https://bless25min.github.io/AIOGEO-Knowledge/sitemap.xml
        
        User-agent: GPTBot
        Allow: /
        
        User-agent: Claude-Web
        Allow: /
        
        User-agent: PerplexityBot
        Allow: /
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "🤖 自動生成 SEO 優化檔案 - $(date +%Y-%m-%d)"
          git push
        fi
