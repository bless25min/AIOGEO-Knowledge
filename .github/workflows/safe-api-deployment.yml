name: ğŸ›¡ï¸ Safe GitHub API Static Deployment

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy-via-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install @octokit/rest markdown-it cheerio fs-extra
        
    - name: Create GitHub API deployment script
      run: |
        cat > deploy-via-api.js << 'EOF'
        const { Octokit } = require('@octokit/rest');
        const fs = require('fs-extra');
        const path = require('path');
        const MarkdownIt = require('markdown-it');
        const md = new MarkdownIt({ html: true });

        const octokit = new Octokit({
          auth: process.env.GITHUB_TOKEN
        });

        const owner = 'bless25min';
        const repo = 'AIOGEO-Knowledge';

        // HTML æ¨¡æ¿ç”Ÿæˆå‡½æ•¸
        function generateHTMLTemplate(title, description, content, canonical) {
          return `<!DOCTYPE html>
        <html lang="zh-TW">
        <head>
          <meta charset="UTF-8">
          <title>${title} | AIOGEO çŸ¥è­˜åº«</title>
          <meta name="description" content="${description}">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <link rel="canonical" href="${canonical}">
          
          <!-- Schema.org æ¨™è¨˜ -->
          <script type="application/ld+json">
          {
            "@context": "https://schema.org",
            "@type": "Article",
            "headline": "${title}",
            "description": "${description}",
            "author": {
              "@type": "Person",
              "name": "å»–å¤©ä½‘ Bless Liao"
            },
            "datePublished": "${new Date().toISOString()}",
            "mainEntityOfPage": "${canonical}"
          }
          </script>
          
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              line-height: 1.7;
              max-width: 900px;
              margin: 0 auto;
              padding: 20px;
              color: #1f2937;
              background: #f8fafc;
            }
            .container {
              background: white;
              padding: 40px;
              border-radius: 12px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            h1 { color: #6366f1; border-bottom: 3px solid #6366f1; padding-bottom: 15px; }
            h2 { color: #374151; margin-top: 30px; border-left: 4px solid #6366f1; padding-left: 15px; }
            .summary {
              background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
              border: 2px solid #0ea5e9;
              border-radius: 12px;
              padding: 24px;
              margin: 25px 0;
              font-size: 1.05em;
            }
            .enhanced-link {
              background: #6366f1;
              color: white;
              padding: 12px 24px;
              border-radius: 8px;
              text-decoration: none;
              display: inline-block;
              margin: 10px 5px;
            }
            pre { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; overflow-x: auto; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; }
            th { background: #f9fafb; font-weight: 600; }
          </style>
        </head>
        <body>
          <div class="container">
            ${content}
            <footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
              <a href="https://bless25min.github.io/AIOGEO-Knowledge/" class="enhanced-link">ğŸ  è¿”å›çŸ¥è­˜åº«</a>
              <p style="color: #6b7280; margin-top: 15px;">ğŸ“š AIOGEO çŸ¥è­˜åº« | ğŸ¯ è®“AIçœ‹è¦‹ä½ çš„å…§å®¹</p>
            </footer>
          </div>
        </body>
        </html>`;
        }

        // è®€å–ä¸¦è½‰æ› Markdown æª”æ¡ˆ
        function processMarkdownFile(filePath) {
          try {
            if (fs.existsSync(filePath)) {
              const content = fs.readFileSync(filePath, 'utf8');
              const cleanContent = content.replace(/^---[\s\S]*?---\n/, '');
              return md.render(cleanContent);
            }
            return '<p>å…§å®¹è¼‰å…¥ä¸­...</p>';
          } catch (error) {
            console.log(`Warning: ${filePath} not found`);
            return '<p>å…§å®¹è¼‰å…¥ä¸­...</p>';
          }
        }

        // é€šé GitHub API å‰µå»ºæˆ–æ›´æ–°æª”æ¡ˆ
        async function createOrUpdateFile(path, content, message) {
          try {
            // å…ˆå˜—è©¦ç²å–ç¾æœ‰æª”æ¡ˆ
            let sha;
            try {
              const { data } = await octokit.rest.repos.getContent({
                owner,
                repo,
                path
              });
              sha = data.sha;
            } catch (error) {
              // æª”æ¡ˆä¸å­˜åœ¨ï¼Œå°‡å‰µå»ºæ–°æª”æ¡ˆ
              console.log(`Creating new file: ${path}`);
            }

            // å‰µå»ºæˆ–æ›´æ–°æª”æ¡ˆ
            await octokit.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message,
              content: Buffer.from(content).toString('base64'),
              sha
            });

            console.log(`âœ… ${path} updated successfully`);
          } catch (error) {
            console.error(`âŒ Failed to update ${path}:`, error.message);
          }
        }

        // ä¸»è¦é é¢é…ç½®
        const pages = [
          {
            mdFile: 'posts/geo-fundamentals.md',
            htmlFile: 'geo-fundamentals.html',
            title: 'GEOåŸºç¤åŸç†å®Œæ•´æŒ‡å—ï¼šAIæœå°‹æ™‚ä»£çš„å…§å®¹å„ªåŒ–ç­–ç•¥',
            description: 'æ·±å…¥è§£æ GEO (ç”Ÿæˆå¼å¼•æ“å„ªåŒ–) åŸºç¤åŸç†ï¼Œæä¾›AIæœå°‹æ™‚ä»£çš„å…§å®¹å„ªåŒ–ç­–ç•¥èˆ‡å¯¦æˆ°æŠ€å·§ã€‚'
          },
          {
            mdFile: 'posts/seo-geo-integration.md',
            htmlFile: 'seo-geo-integration.html',
            title: 'SEOÃ—GEOé›™è»Œæ•´åˆå¯¦æˆ°æŒ‡å—',
            description: 'SEOèˆ‡GEOé›™è»Œå„ªåŒ–ç­–ç•¥ï¼Œæ•´åˆå‚³çµ±æœå°‹å¼•æ“å„ªåŒ–èˆ‡AIå¼•ç”¨å„ªåŒ–çš„å®Œæ•´å¯¦æ–½æ¡†æ¶ã€‚'
          },
          {
            mdFile: 'posts/semantic-mesh.md',
            htmlFile: 'semantic-mesh.html',
            title: 'Semantic Meshèªæ„çŸ©é™£ï¼šå»ºç«‹æ™ºæ…§å…§å®¹ç¶²çµ¡',
            description: 'Semantic Meshæ¶æ§‹è¨­è¨ˆå®Œæ•´æŒ‡å—ï¼Œå»ºç«‹ä¸»å¹¹é ã€å­ä¸»é¡Œé ã€å¾®å‹é ä¸‰å±¤å…§å®¹ç¶²çµ¡ã€‚'
          },
          {
            mdFile: 'tools/checklists.md',
            htmlFile: 'tools-checklists.html',
            title: 'GEOå„ªåŒ–æª¢æŸ¥æ¸…å–®',
            description: 'å®Œæ•´çš„GEOå„ªåŒ–æª¢æŸ¥æ¸…å–®ï¼Œæä¾›é€é …å°ç…§çš„å„ªåŒ–è¦é»å’Œå“è³ªæ¨™æº–ã€‚'
          }
        ];

        // ç”Ÿæˆå®Œæ•´çš„éœæ…‹é é¢
        async function deployStaticPages() {
          console.log('ğŸš€ é–‹å§‹é€šé GitHub API éƒ¨ç½²éœæ…‹é é¢...');

          // è™•ç†ä¸»è¦é é¢
          for (const page of pages) {
            const content = processMarkdownFile(page.mdFile);
            const canonical = `https://bless25min.github.io/AIOGEO-Knowledge/${page.htmlFile}`;
            const html = generateHTMLTemplate(page.title, page.description, content, canonical);
            
            await createOrUpdateFile(
              page.htmlFile,
              html,
              `ğŸ“„ æ›´æ–°éœæ…‹é é¢: ${page.title}`
            );
          }

          // æ›´æ–° sitemap.xml
          const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>1.0</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals.html</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.95</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/seo-geo-integration.html</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.9</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/semantic-mesh.html</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.85</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/tools-checklists.html</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.8</priority>
            </url>
        </urlset>`;

          await createOrUpdateFile(
            'sitemap.xml',
            sitemap,
            'ğŸ—ºï¸ æ›´æ–° Sitemap åŒ…å«éœæ…‹é é¢'
          );

          console.log('ğŸ‰ éœæ…‹é é¢éƒ¨ç½²å®Œæˆï¼');
        }

        // åŸ·è¡Œéƒ¨ç½²
        deployStaticPages().catch(console.error);
        EOF
        
    - name: Deploy static pages via GitHub API
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        node deploy-via-api.js
