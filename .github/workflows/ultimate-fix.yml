name: ğŸ›¡ï¸ Ultimate Static Pages Deployment - Conflict Resolution

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼·åˆ¶é‡å»ºæ‰€æœ‰é é¢'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

# ç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹éƒ¨ç½²åœ¨é€²è¡Œ
concurrency:
  group: "static-deployment"
  cancel-in-progress: false

jobs:
  deploy-all-static-pages:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ› ï¸ Configure Git safely
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "AIOGEO Auto Deploy"
        git config pull.rebase false
        git config --local core.autocrlf false

    - name: ğŸ”„ Force sync with remote
      run: |
        echo "ğŸ”„ å¼·åˆ¶åŒæ­¥é ç«¯è®Šæ›´..."
        git fetch origin main
        git reset --hard origin/main
        git clean -fd

    - name: ğŸ“‹ Read existing content
      run: |
        echo "ğŸ“‹ è®€å–å°ˆæ¡ˆå…§å®¹..."
        
        # åˆ—å‡ºæ‰€æœ‰ Markdown æª”æ¡ˆ
        echo "=== Posts ç›®éŒ„å…§å®¹ ==="
        find posts -name "*.md" -type f | sort
        echo ""
        
        echo "=== Tools ç›®éŒ„å…§å®¹ ==="
        find tools -name "*.md" -type f | sort
        echo ""
        
        echo "=== æ ¹ç›®éŒ„ Markdown æª”æ¡ˆ ==="
        find . -maxdepth 1 -name "*.md" -type f | sort

    - name: ğŸš€ Generate all static HTML pages
      run: |
        echo "ğŸš€ é–‹å§‹ç”Ÿæˆæ‰€æœ‰éœæ…‹é é¢..."
        
        # å‡½æ•¸ï¼šç”Ÿæˆæ¨™æº– HTML é é¢
        generate_html_page() {
          local title="$1"
          local description="$2"
          local canonical_url="$3"
          local redirect_url="$4"
          local content="$5"
          local output_file="$6"
          
          cat > "$output_file" << EOF
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>$title | AIOGEO çŸ¥è­˜åº«</title>
          <meta name="description" content="$description">
          <meta name="keywords" content="GEO, AIæœå°‹å„ªåŒ–, å»–å¤©ä½‘, Bless Liao, AIå¼•ç”¨, å…§å®¹å„ªåŒ–">
          <meta name="author" content="å»–å¤©ä½‘ Bless Liao">
          
          <!-- Open Graph -->
          <meta property="og:title" content="$title | AIOGEO çŸ¥è­˜åº«">
          <meta property="og:description" content="$description">
          <meta property="og:type" content="article">
          <meta property="og:url" content="$canonical_url">
          <meta property="og:site_name" content="AIOGEO çŸ¥è­˜åº«">
          <meta property="og:locale" content="zh_TW">
          
          <!-- Twitter Card -->
          <meta name="twitter:card" content="summary_large_image">
          <meta name="twitter:title" content="$title | AIOGEO çŸ¥è­˜åº«">
          <meta name="twitter:description" content="$description">
          
          <!-- é‡å®šå‘å’Œè¦ç¯„ URL -->
          <meta http-equiv="refresh" content="0; url=$redirect_url">
          <link rel="canonical" href="$canonical_url">
          
          <!-- æ¨£å¼ -->
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              line-height: 1.6;
              color: #333;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
            }
            .container {
              background: white;
              padding: 40px;
              border-radius: 15px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.1);
              text-align: center;
            }
            .logo {
              font-size: 3em;
              margin-bottom: 20px;
            }
            h1 {
              color: #6366f1;
              margin-bottom: 10px;
            }
            .subtitle {
              color: #6b7280;
              margin-bottom: 30px;
              font-size: 1.2em;
            }
            .redirect-message {
              background: #f0f9ff;
              border: 2px solid #0ea5e9;
              border-radius: 10px;
              padding: 20px;
              margin: 20px 0;
            }
            .link {
              color: #6366f1;
              text-decoration: none;
              font-weight: bold;
            }
            .link:hover {
              text-decoration: underline;
            }
            .loading {
              margin: 20px 0;
            }
            .spinner {
              border: 4px solid #f3f4f6;
              border-top: 4px solid #6366f1;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 1s linear infinite;
              margin: 0 auto;
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          </style>
          
          <!-- JavaScript é‡å®šå‘ -->
          <script>
            // ç«‹å³é‡å®šå‘
            window.location.href = '$redirect_url';
            
            // å‚™ç”¨é‡å®šå‘
            setTimeout(function() {
              if (window.location.href !== '$redirect_url') {
                window.location.href = '$redirect_url';
              }
            }, 100);
          </script>
          
          <!-- Schema.org çµæ§‹åŒ–è³‡æ–™ -->
          <script type="application/ld+json">
          {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "$title",
            "description": "$description",
            "url": "$canonical_url",
            "author": {
              "@type": "Person",
              "name": "å»–å¤©ä½‘ Bless Liao",
              "url": "https://github.com/bless25min"
            },
            "publisher": {
              "@type": "Organization",
              "name": "AIOGEO çŸ¥è­˜åº«",
              "url": "https://bless25min.github.io/AIOGEO-Knowledge/"
            },
            "mainEntity": {
              "@type": "Article",
              "headline": "$title",
              "description": "$description",
              "author": {
                "@type": "Person",
                "name": "å»–å¤©ä½‘ Bless Liao"
              }
            }
          }
          </script>
        </head>
        <body>
          <div class="container">
            <div class="logo">ğŸ¤–</div>
            <h1>$title</h1>
            <p class="subtitle">AIOGEO çŸ¥è­˜åº« - AI æœå°‹å„ªåŒ–å°ˆæ¥­æŒ‡å—</p>
            
            <div class="redirect-message">
              <p><strong>æ­£åœ¨é‡å®šå‘åˆ°å®Œæ•´é é¢...</strong></p>
              <div class="loading">
                <div class="spinner"></div>
              </div>
              <p>å¦‚æœé é¢æ²’æœ‰è‡ªå‹•è·³è½‰ï¼Œè«‹ <a href="$redirect_url" class="link">é»æ“Šé€™è£¡</a></p>
            </div>
            
            $content
            
            <hr style="margin: 30px 0;">
            <p><small>
              ğŸ“š <a href="https://bless25min.github.io/AIOGEO-Knowledge/" class="link">å›åˆ°é¦–é </a> | 
              ğŸ“§ <a href="https://github.com/bless25min" class="link">è¯ç¹«ä½œè€…</a> | 
              â­ <a href="https://github.com/bless25min/AIOGEO-Knowledge" class="link">GitHub</a>
            </small></p>
          </div>
        </body>
        </html>
        EOF
        }
        
        # ç”Ÿæˆä¸»è¦é é¢
        echo "ğŸ“„ ç”Ÿæˆ about.html..."
        generate_html_page \
          "é—œæ–¼ä½œè€…" \
          "å»–å¤©ä½‘ Bless Liao - GEO (ç”Ÿæˆå¼å¼•æ“å„ªåŒ–) å°ˆå®¶ï¼Œå°ˆç²¾AIæœå°‹å„ªåŒ–ç­–ç•¥èˆ‡å…§å®¹æ¶æ§‹è¨­è¨ˆ" \
          "https://bless25min.github.io/AIOGEO-Knowledge/about.html" \
          "https://bless25min.github.io/AIOGEO-Knowledge/#/about" \
          "<p>äº†è§£ AIOGEO çŸ¥è­˜åº«å‰µå»ºè€…å»–å¤©ä½‘ (Bless Liao) çš„å°ˆæ¥­èƒŒæ™¯ã€æŠ€èƒ½å°ˆé•·å’Œè±å¯Œç¶“é©—ã€‚</p>" \
          "about.html"
        
        echo "ğŸ“„ ç”Ÿæˆ contributing.html..."
        generate_html_page \
          "åƒèˆ‡è²¢ç»" \
          "åŠ å…¥ AIOGEO çŸ¥è­˜åº«å»ºè¨­ï¼Œå…±åŒæ¨å‹• GEO é ˜åŸŸç™¼å±•ã€‚æä¾›è²¢ç»æŒ‡å—èˆ‡æœ€ä½³å¯¦å‹™åˆ†äº«" \
          "https://bless25min.github.io/AIOGEO-Knowledge/contributing.html" \
          "https://bless25min.github.io/AIOGEO-Knowledge/#/contributing" \
          "<p>æ­¡è¿åƒèˆ‡ AIOGEO çŸ¥è­˜åº«çš„å…§å®¹å»ºè¨­ï¼Œäº†è§£å¦‚ä½•è²¢ç»é«˜å“è³ªçš„ GEO ç›¸é—œæ–‡ç« å’Œè³‡æºã€‚</p>" \
          "contributing.html"
        
        # è‡ªå‹•ç”Ÿæˆæ‰€æœ‰ posts ç›®éŒ„ä¸‹çš„æ–‡ç« é é¢
        echo "ğŸ“š ç”Ÿæˆæ–‡ç« éœæ…‹é é¢..."
        if [ -d "posts" ]; then
          for file in posts/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              echo "  ğŸ“ ç”Ÿæˆ ${filename}.html..."
              
              # æå–æ–‡ç« æ¨™é¡Œï¼ˆå‡è¨­ç¬¬ä¸€è¡Œæ˜¯ # æ¨™é¡Œï¼‰
              title=$(head -n 20 "$file" | grep -m 1 "^# " | sed 's/^# //' | sed 's/\*//g' || echo "$filename")
              [ -z "$title" ] && title="$filename"
              
              # æå–æè¿°ï¼ˆå°‹æ‰¾æ‘˜è¦æˆ–ç¬¬ä¸€æ®µæ–‡å­—ï¼‰
              description=$(head -n 50 "$file" | grep -A 5 -E "(æ‘˜è¦|summary|æè¿°)" | head -n 3 | tail -n 1 | sed 's/[#*`]//g' | cut -c1-150 || echo "AIOGEO çŸ¥è­˜åº«å°ˆæ¥­æ–‡ç«  - $title")
              [ -z "$description" ] && description="AIOGEO çŸ¥è­˜åº«å°ˆæ¥­æ–‡ç«  - $titleï¼Œæä¾› AI æœå°‹å„ªåŒ–çš„æ·±åº¦è§£æèˆ‡å¯¦æˆ°æŒ‡å—"
              
              generate_html_page \
                "$title" \
                "$description" \
                "https://bless25min.github.io/AIOGEO-Knowledge/${filename}.html" \
                "https://bless25min.github.io/AIOGEO-Knowledge/#/posts/${filename}" \
                "<p>é–±è®€å®Œæ•´æ–‡ç« å…§å®¹ï¼Œäº†è§£ $title çš„è©³ç´°è§£æå’Œå¯¦ç”¨æŒ‡å—ã€‚</p>" \
                "${filename}.html"
            fi
          done
        fi
        
        # è‡ªå‹•ç”Ÿæˆæ‰€æœ‰ tools ç›®éŒ„ä¸‹çš„å·¥å…·é é¢
        echo "ğŸ› ï¸ ç”Ÿæˆå·¥å…·é é¢..."
        if [ -d "tools" ]; then
          for file in tools/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              echo "  ğŸ”§ ç”Ÿæˆ tools-${filename}.html..."
              
              title=$(head -n 20 "$file" | grep -m 1 "^# " | sed 's/^# //' | sed 's/\*//g' || echo "å·¥å…· - $filename")
              [ -z "$title" ] && title="å·¥å…· - $filename"
              
              description="AIOGEO å¯¦ç”¨å·¥å…· - $titleï¼Œæä¾›å°ˆæ¥­çš„ GEO å„ªåŒ–å·¥å…·å’Œè³‡æº"
              
              generate_html_page \
                "$title" \
                "$description" \
                "https://bless25min.github.io/AIOGEO-Knowledge/tools-${filename}.html" \
                "https://bless25min.github.io/AIOGEO-Knowledge/#/tools/${filename}" \
                "<p>ä½¿ç”¨å°ˆæ¥­å·¥å…·æå‡æ‚¨çš„ GEO å„ªåŒ–æ•ˆæœï¼Œ$title æä¾›å¯¦ç”¨çš„åŠŸèƒ½å’ŒæŒ‡å—ã€‚</p>" \
                "tools-${filename}.html"
            fi
          done
        fi

    - name: ğŸ—ºï¸ Generate comprehensive sitemap.xml
      run: |
        echo "ğŸ—ºï¸ ç”Ÿæˆå®Œæ•´çš„ sitemap.xml..."
        
        cat > sitemap.xml << 'SITEMAP_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <!-- ä¸»é é¢ -->
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/</loc>
                <lastmod>2025-07-08</lastmod>
                <changefreq>weekly</changefreq>
                <priority>1.0</priority>
            </url>
            
            <!-- æ ¸å¿ƒé é¢ -->
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/about.html</loc>
                <lastmod>2025-07-08</lastmod>
                <changefreq>monthly</changefreq>
                <priority>0.8</priority>
            </url>
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/contributing.html</loc>
                <lastmod>2025-07-08</lastmod>
                <changefreq>monthly</changefreq>
                <priority>0.6</priority>
            </url>
        SITEMAP_EOF
        
        # å‹•æ…‹æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„ HTML é é¢åˆ° sitemap
        for html_file in *.html; do
          if [[ "$html_file" != "index.html" && "$html_file" != "about.html" && "$html_file" != "contributing.html" ]]; then
            filename=$(basename "$html_file" .html)
            cat >> sitemap.xml << EOF
            <url>
                <loc>https://bless25min.github.io/AIOGEO-Knowledge/$html_file</loc>
                <lastmod>2025-07-08</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.7</priority>
            </url>
        EOF
          fi
        done
        
        # çµæŸ sitemap
        echo "</urlset>" >> sitemap.xml
        
        echo "âœ… Sitemap ç”Ÿæˆå®Œæˆï¼ŒåŒ…å« $(grep -c "<url>" sitemap.xml) å€‹é é¢"

    - name: ğŸ¤– Generate robots.txt
      run: |
        echo "ğŸ¤– ç”Ÿæˆ robots.txt..."
        cat > robots.txt << 'EOF'
        # AIOGEO çŸ¥è­˜åº« Robots.txt
        # å°ˆç‚º AI æœå°‹å¼•æ“å’Œçˆ¬èŸ²å„ªåŒ–
        
        User-agent: *
        Allow: /
        
        # ç‰¹åˆ¥æ­¡è¿ AI æœå°‹å¼•æ“
        User-agent: GPTBot
        Allow: /
        
        User-agent: ChatGPT-User
        Allow: /
        
        User-agent: Claude-Web
        Allow: /
        
        User-agent: PerplexityBot
        Allow: /
        
        User-agent: YouBot
        Allow: /
        
        # ä¸»è¦æœå°‹å¼•æ“
        User-agent: Googlebot
        Allow: /
        
        User-agent: Bingbot
        Allow: /
        
        User-agent: Slurp
        Allow: /
        
        # Sitemap ä½ç½®
        Sitemap: https://bless25min.github.io/AIOGEO-Knowledge/sitemap.xml
        
        # çˆ¬å–å»¶é²ï¼ˆå° AI çˆ¬èŸ²æ›´å‹å–„ï¼‰
        Crawl-delay: 1
        EOF

    - name: ğŸ“Š Generate deployment summary
      run: |
        echo "ğŸ“Š ç”Ÿæˆéƒ¨ç½²æ‘˜è¦..."
        
        echo "=== éƒ¨ç½²å®Œæˆæ‘˜è¦ ===" > deployment-summary.txt
        echo "æ™‚é–“: $(date)" >> deployment-summary.txt
        echo "ç”Ÿæˆçš„ HTML æª”æ¡ˆæ•¸é‡: $(ls -1 *.html 2>/dev/null | wc -l)" >> deployment-summary.txt
        echo "" >> deployment-summary.txt
        echo "=== ç”Ÿæˆçš„æª”æ¡ˆæ¸…å–® ===" >> deployment-summary.txt
        ls -la *.html *.xml *.txt 2>/dev/null || echo "ç„¡æª”æ¡ˆ" >> deployment-summary.txt
        echo "" >> deployment-summary.txt
        echo "=== Sitemap å…§å®¹æª¢æŸ¥ ===" >> deployment-summary.txt
        echo "URL ç¸½æ•¸: $(grep -c "<loc>" sitemap.xml 2>/dev/null || echo "0")" >> deployment-summary.txt
        echo "" >> deployment-summary.txt
        
        cat deployment-summary.txt

    - name: ğŸš€ Safe commit and push
      run: |
        echo "ğŸš€ å®‰å…¨æäº¤æ‰€æœ‰è®Šæ›´..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ ç™¼ç¾æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™æäº¤..."
          
          # æ·»åŠ æ‰€æœ‰è®Šæ›´çš„æª”æ¡ˆ
          git add *.html *.xml *.txt 2>/dev/null || true
          
          # ç¢ºä¿æœ‰æª”æ¡ˆå¯ä»¥æäº¤
          if [ -n "$(git diff --cached --name-only)" ]; then
            echo "ğŸ“¦ æäº¤è®Šæ›´..."
            git commit -m "ğŸš€ è‡ªå‹•ç”Ÿæˆæ‰€æœ‰éœæ…‹é é¢ - $(date +%Y-%m-%d-%H%M%S)

            âœ… ç”Ÿæˆæª”æ¡ˆæ¸…å–®:
            $(git diff --cached --name-only | sed 's/^/- /')
            
            ğŸ“Š çµ±è¨ˆ:
            - HTML é é¢: $(ls -1 *.html 2>/dev/null | wc -l) å€‹
            - Sitemap URLs: $(grep -c "<loc>" sitemap.xml 2>/dev/null || echo "0") å€‹
            - éƒ¨ç½²æ™‚é–“: $(date)
            
            ğŸ¯ å„ªåŒ–æ•ˆæœ:
            - è§£æ±ºæ‰€æœ‰ 404 éŒ¯èª¤
            - å®Œæ•´ SEO å„ªåŒ–
            - AI çˆ¬èŸ²å‹å–„è¨­å®š
            - è‡ªå‹•é‡å®šå‘åŠŸèƒ½"
            
            # å¼·åˆ¶æ¨é€ï¼ˆè§£æ±ºåˆ†æ”¯è¡çªï¼‰
            echo "ğŸ”„ æ¨é€è®Šæ›´åˆ°é ç«¯..."
            git push origin main --force-with-lease
            
            echo "âœ… æ‰€æœ‰è®Šæ›´å·²æˆåŠŸæ¨é€ï¼"
          else
            echo "â„¹ï¸ æ²’æœ‰æª”æ¡ˆéœ€è¦æäº¤"
          fi
        else
          echo "â„¹ï¸ æ²’æœ‰æª”æ¡ˆè®Šæ›´"
        fi

    - name: ğŸ‰ Deployment completion
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo ""
        echo "âœ… æˆåŠŸç”Ÿæˆçš„æª”æ¡ˆ:"
        ls -la *.html *.xml *.txt 2>/dev/null | awk '{print "  " $0}'
        echo ""
        echo "ğŸŒ æ¸¬è©¦ URL:"
        echo "  ğŸ“„ é—œæ–¼é é¢: https://bless25min.github.io/AIOGEO-Knowledge/about.html"
        echo "  ğŸ“ è²¢ç»æŒ‡å—: https://bless25min.github.io/AIOGEO-Knowledge/contributing.html"
        echo "  ğŸ—ºï¸ Sitemap: https://bless25min.github.io/AIOGEO-Knowledge/sitemap.xml"
        echo "  ğŸ¤– Robots: https://bless25min.github.io/AIOGEO-Knowledge/robots.txt"
        echo ""
        echo "ğŸ“Š ä¸‹ä¸€æ­¥:"
        echo "  1. ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œæˆï¼ˆ2-3åˆ†é˜ï¼‰"
        echo "  2. æ¸¬è©¦æ‰€æœ‰é é¢æ˜¯å¦æ­£å¸¸"
        echo "  3. æäº¤ sitemap åˆ° Google Search Console"
        echo "  4. ç›£æ§ SEO æ•ˆæœ"
        echo ""
        echo "ğŸ¯ é æœŸæ•ˆæœ:"
        echo "  âœ… è§£æ±ºæ‰€æœ‰ 404 éŒ¯èª¤"
        echo "  âœ… æå‡ SEO æ’å"
        echo "  âœ… å¢åŠ  AI å¼•ç”¨æ©Ÿç‡"
        echo "  âœ… æ”¹å–„ç”¨æˆ¶é«”é©—"
