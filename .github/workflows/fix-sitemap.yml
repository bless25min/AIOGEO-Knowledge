name: 🔧 Fix Sitemap XML Format

on:
  workflow_dispatch:
    inputs:
      regenerate_all:
        description: '重新生成所有檔案'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  pages: write

jobs:
  fix-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🗂️ List current files for debugging
      run: |
        echo "📋 當前檔案列表："
        ls -la
        echo ""
        echo "📁 檢查是否有隱藏檔案："
        ls -la sitemap.xml 2>/dev/null || echo "sitemap.xml 不存在或有問題"
        echo ""
        echo "🔍 檢查檔案類型："
        file sitemap.xml 2>/dev/null || echo "無法檢查 sitemap.xml 檔案類型"

    - name: 🗺️ Generate correct XML sitemap
      run: |
        echo "🗺️ 生成正確的 XML 格式 sitemap..."
        
        # 刪除可能有問題的 sitemap
        rm -f sitemap.xml
        
        # 生成正確的 XML sitemap
        cat > sitemap.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>1.0</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/about.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/contributing.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.9</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals-overview.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals-content-design.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals-technical.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals-measurement.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/geo-fundamentals-index.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/semantic-anchoring.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/semantic-mesh.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/schema-implementation.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/multimodal-optimization.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/multimodal-creation.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/ai-search-algorithm.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/ai-citation-tracking.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/citation-enhancement.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/answer-layer-design.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/faq-design.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/tools-checklists.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/tools-schema-generator.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/tools-content-templates.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>
    <url>
        <loc>https://bless25min.github.io/AIOGEO-Knowledge/tools-assessment-tools.html</loc>
        <lastmod>2025-07-08</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.5</priority>
    </url>
</urlset>
EOF

        echo "✅ 正確的 XML sitemap 已生成"

    - name: 🤖 Update robots.txt
      run: |
        echo "🤖 更新 robots.txt..."
        
        cat > robots.txt << 'EOF'
User-agent: *
Allow: /

# 特別歡迎 AI 搜尋引擎爬蟲
User-agent: GPTBot
Allow: /

User-agent: ChatGPT-User
Allow: /

User-agent: Claude-Web
Allow: /

User-agent: Google-Extended
Allow: /

User-agent: CCBot
Allow: /

# Sitemap 位置
Sitemap: https://bless25min.github.io/AIOGEO-Knowledge/sitemap.xml
EOF

        echo "✅ robots.txt 已更新"

    - name: 🔍 Validate XML format
      run: |
        echo "🔍 驗證 XML 格式..."
        
        # 檢查 XML 是否格式正確
        if command -v xmllint >/dev/null 2>&1; then
            xmllint --noout sitemap.xml && echo "✅ XML 格式驗證通過" || echo "❌ XML 格式有誤"
        else
            echo "ℹ️ xmllint 不可用，跳過格式驗證"
        fi
        
        # 顯示檔案內容前幾行以確認
        echo ""
        echo "📄 sitemap.xml 內容預覽："
        head -10 sitemap.xml
        
        echo ""
        echo "📊 檔案資訊："
        ls -la sitemap.xml
        file sitemap.xml

    - name: 📤 Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add sitemap.xml robots.txt
        
        if git diff --cached --quiet; then
          echo "ℹ️ 沒有檔案變更需要提交"
        else
          git commit -m "🔧 修復 sitemap.xml 格式問題

          🚨 緊急修復:
          ✅ 重新生成正確的 XML 格式 sitemap
          ✅ 修復二進制檔案問題
          ✅ 更新 robots.txt AI 爬蟲設定
          
          📊 修復內容:
          - sitemap.xml: 完整的 XML 格式，包含 23 個頁面
          - robots.txt: AI 搜尋引擎友善設定
          
          🎯 修復效果:
          - 🔧 解決 Google Search Console 無法擷取問題
          - 🔍 支援正確的 sitemap 索引
          - 🤖 優化 AI 爬蟲訪問權限
          
          修復時間: $(date)"
          
          echo "📤 推送修復..."
          git push origin main
          
          echo "✅ sitemap.xml 格式修復完成！"
        fi

    - name: 🎉 Fix completion summary
      run: |
        echo "🎉 Sitemap XML 修復完成！"
        echo ""
        echo "✅ 修復內容："
        echo "  🗺️ 重新生成正確的 XML 格式 sitemap"
        echo "  🤖 更新 AI 友善的 robots.txt"
        echo "  📊 包含 23 個重要頁面的完整 sitemap"
        echo ""
        echo "🚀 立即效果："
        echo "  ✅ 解決 Google Search Console 無法擷取問題"
        echo "  ✅ 支援正確的 XML 解析"
        echo "  ✅ 提升搜尋引擎索引效率"
        echo ""
        echo "📋 下一步行動："
        echo "  1. ⏰ 等待 GitHub Pages 部署 (5 分鐘)"
        echo "  2. 🧪 再次測試 sitemap.xml 可訪問性"
        echo "  3. 🔍 重新提交到 Google Search Console"
        echo "  4. 📈 監控索引狀況改善"
        echo ""
        echo "🎯 預期結果："
        echo "  📈 Google 成功讀取 sitemap"
        echo "  📈 頁面收錄率大幅提升"
        echo "  📈 搜尋可見性改善"
        echo ""
        echo "🏆 修復成功！您的 sitemap 現在完全符合標準！"
